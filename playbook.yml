---
- name: Schulsystem Installation & Konfiguration (Final v6)
  hosts: computers
  become: yes

  vars:
    admin_user: "linuxadmin"
    kiosk_user: "user0"
    template_dir: "/home/{{ admin_user }}/TEMPLATE"
    
    # Hashes werden vom install.sh übergeben.
    
    # --- BASIS PAKET LISTE ---
    packages_system:
      - xubuntu-desktop
      - lightdm
      - vim
      - git
      - rsync
      - htop
      - tree
      - gparted
      - net-tools
      - unrar
      - python3-pip
      - apt-transport-https
      # ISO Tools
      - xorriso
      - isolinux
      - syslinux-utils
      - squashfs-tools
      # Java
      - default-jdk
      - default-jre
      - openjdk-8-jre
      - openjdk-8-jdk
      # Multimedia & Grafik
      - vlc
      - gimp
      - feh
      - simplescreenrecorder
      - qrencode
      # Netzwerk & Fernwartung
      - openssh-server
      - veyon-service
      - tigervnc-viewer
      # Flatpak
      - flatpak
      - gnome-software-plugin-flatpak
      # Office
      - libreoffice
      - libreoffice-l10n-de
      - libreoffice-help-de
      # Wine
      - wine
      - winetricks

    packages_edu:
      - geogebra
      - scratch
      - xournal
      - stellarium
      - cura
      - umbrello

  tasks:
    # =========================================================================
    # 1. VORBEREITUNG (WICHTIG: Tools für PPAs zuerst!)
    # =========================================================================
    
    - name: Notwendige Tools für Repository-Management installieren
      apt:
        name:
          - software-properties-common
          - gpg-agent
          - curl
          - ca-certificates
          - gnupg2
        state: present
        update_cache: yes

    - name: Universe und Multiverse Repositories aktivieren
      apt_repository:
        repo: "{{ item }}"
        state: present
      loop:
        - "deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }} universe"
        - "deb http://archive.ubuntu.com/ubuntu {{ ansible_distribution_release }} multiverse"

    # FIX: Keyserver Port 80 erzwingen, um Firewall zu umgehen
    - name: PPAs hinzufügen (mit Port 80 Fix)
      apt_repository:
        repo: "{{ item }}"
        state: present
        update_cache: yes
        keyserver: hkp://keyserver.ubuntu.com:80
      loop:
        - ppa:gezakovacs/ppa
        - ppa:veyon/stable
      ignore_errors: yes

    - name: Microsoft Edge Repository hinzufügen
      block:
        - apt_key:
            url: https://packages.microsoft.com/keys/microsoft.asc
            state: present
        - apt_repository:
            repo: "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main"
            state: present

    - name: Apt Cache komplett aktualisieren
      apt:
        update_cache: yes

    # =========================================================================
    # 2. SOFTWARE INSTALLATION (APT)
    # =========================================================================

    - name: Basis-Software installieren
      apt:
        name: "{{ packages_system }}"
        state: present

    - name: Edu-Software installieren (Best Effort)
      apt:
        name: "{{ packages_edu }}"
        state: present
      ignore_errors: yes

    - name: Weitere Pakete installieren (Edge, Unetbootin)
      apt:
        name:
          - microsoft-edge-dev
          - unetbootin
        state: present
      ignore_errors: yes

    # =========================================================================
    # 3. EXTERNE DEB PAKETE
    # =========================================================================

    - name: Google Chrome
      block:
        - get_url:
            url: https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
            dest: /tmp/google-chrome.deb
        - apt:
            deb: /tmp/google-chrome.deb

    - name: OpenBoard
      block:
        - get_url:
            url: https://github.com/OpenBoard-org/OpenBoard/releases/download/v1.7.2/openboard_debian_12_1.7.2_amd64.deb
            dest: /tmp/openboard.deb
        - apt:
            deb: /tmp/openboard.deb
      ignore_errors: yes

    - name: Greenfoot
      block:
        - get_url:
            url: https://www.greenfoot.org/download/files/Greenfoot-linux-x64-390.deb
            dest: /tmp/greenfoot.deb
        - apt:
            deb: /tmp/greenfoot.deb

    # --- VIRTUALBOX ---
    - name: VirtualBox installieren
      block:
        - debconf:
            name: virtualbox-ext-pack
            question: virtualbox-ext-pack/license
            vtype: select
            value: 'true'
        - apt:
            name: [virtualbox, virtualbox-ext-pack, virtualbox-qt, virtualbox-dkms]
            state: present

    # =========================================================================
    # 4. SNAP & FLATPAK
    # =========================================================================

    - name: Snap Pakete installieren
      community.general.snap:
        name: "{{ item.name }}"
        classic: "{{ item.classic | default(false) }}"
      loop:
        - { name: netbeans, classic: yes }
        - { name: intellij-idea-community, classic: yes }
        - { name: eclipse, classic: yes }
        - { name: blender, classic: yes }
        - { name: cura-slicer }
        - { name: bluej }
        - { name: arduino }

    - name: Flathub aktivieren
      community.general.flatpak_remote:
        name: flathub
        state: present
        flatpakrepo_url: https://flathub.org/repo/flathub.flatpakrepo

    # =========================================================================
    # 5. ISO CREATOR (PENGUINS EGGS)
    # =========================================================================

    - name: Eggs installieren
      block:
        - get_url:
            url: https://sourceforge.net/projects/penguins-eggs/files/get-eggs/eggs_9.6.5-1_amd64.deb/download
            dest: /tmp/eggs.deb
        - apt:
            deb: /tmp/eggs.deb
      rescue:
        - apt_repository:
            repo: ppa:pieroproietti/penguins-eggs
        - apt:
            name: eggs
            state: present
      ignore_errors: yes

    # =========================================================================
    # 6. USER & GRUPPEN SETUP
    # =========================================================================

    - name: Admin User anlegen
      user:
        name: "{{ admin_user }}"
        password: "{{ admin_password_hash }}"
        update_password: on_create
        shell: /bin/bash
        groups: sudo,plugdev,users
        append: yes

    - name: Kiosk User anlegen
      user:
        name: "{{ kiosk_user }}"
        password: "{{ kiosk_password_hash }}"
        shell: /bin/bash
        groups: audio,video,plugdev,users
        append: yes

    # =========================================================================
    # 7. AUTO-LOGIN (LightDM)
    # =========================================================================

    - name: LightDM Konfigurationsordner prüfen
      file:
        path: /etc/lightdm/lightdm.conf.d
        state: directory
        mode: '0755'

    - name: Autologin für Kiosk User setzen
      copy:
        dest: /etc/lightdm/lightdm.conf.d/12-autologin.conf
        content: |
          [Seat:*]
          autologin-user={{ kiosk_user }}
          autologin-user-timeout=0
        owner: root
        group: root
        mode: '0644'

    # =========================================================================
    # 8. KONFIGURATION & DATEIEN
    # =========================================================================

    - name: Veyon Konfiguration
      block:
        - group:
            name: veyon-student
            state: present
        - user:
            name: "{{ kiosk_user }}"
            groups: veyon-student
            append: yes
        - command: veyon-cli config import files/veyon-config.json
          args:
            removes: files/veyon-config.json
          ignore_errors: yes

    - name: LuPo Script installieren
      copy:
        src: files/lupo.sh
        dest: /usr/bin/lupo.sh
        owner: root
        group: root
        mode: '0755'

    - name: Winetricks Update (falls möglich)
      command: winetricks --self-update
      failed_when: false
      ignore_errors: yes

    - name: Software Verzeichnis kopieren
      copy:
        src: software/
        dest: /tmp/software/
        mode: '0777'

    - name: Wallpaper setzen
      copy:
        src: files/schulsystem-wallpaper.jpg
        dest: /usr/share/backgrounds/schulsystem-wallpaper.jpg
        mode: '0644'
      ignore_errors: yes

    # FIX: Hier wurde der Syntax-Fehler behoben.
    # Wir haben den Block aufgeteilt in zwei separate Tasks.
    - name: ISO Download Ordner erstellen
      file:
        path: /isos
        state: directory
        mode: '0755'

    - name: Xubuntu ISO herunterladen (Timeout 15m)
      get_url:
        url: http://ftp.uni-kl.de/pub/linux/ubuntu-dvd/xubuntu/releases/22.04.5/release/xubuntu-22.04.5-desktop-amd64.iso
        dest: /isos/xubuntu-22.04.5-desktop-amd64.iso
        mode: '0644'
        timeout: 900

    # =========================================================================
    # 9. KIOSK MECHANIK
    # =========================================================================

    - name: Template Verzeichnis anlegen
      file:
        path: "{{ template_dir }}"
        state: directory
        owner: "{{ admin_user }}"
        group: "{{ admin_user }}"
        mode: '0755'

    - name: Reset-Skripte installieren
      copy:
        src: "files/{{ item.src }}"
        dest: "{{ item.dest }}"
        mode: '0755'
      loop:
        - { src: 'reset-kiosk.sh', dest: '/usr/local/bin/reset-kiosk.sh' }
        - { src: 'create-iso.sh', dest: '/usr/local/bin/create-iso.sh' }

    - name: Systemd Reset Service installieren
      copy:
        src: files/kiosk-reset.service
        dest: /etc/systemd/system/kiosk-reset.service
        mode: '0644'
      notify: restart_kiosk_service

    - name: Template initial befüllen (nur wenn leer)
      shell: |
        if [ -z "$(ls -A {{ template_dir }})" ]; then
           rsync -a /etc/skel/ {{ template_dir }}/
           chown -R {{ kiosk_user }}:{{ kiosk_user }} {{ template_dir }}
        fi
      register: template_init
      changed_when: template_init.stdout != ""

    # =========================================================================
    # 10. DIENSTE STARTEN
    # =========================================================================

    - name: Dienste aktivieren
      systemd:
        name: "{{ item }}"
        enabled: yes
        state: started
        daemon_reload: yes
      loop:
        - kiosk-reset.service
        - ssh
        - veyon.service
      ignore_errors: yes

  handlers:
    - name: restart_kiosk_service
      systemd:
        name: kiosk-reset.service
        state: restarted
        daemon_reload: yes
